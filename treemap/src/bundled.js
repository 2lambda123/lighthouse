/*
* @license Copyright 2020 The Lighthouse Authors. All Rights Reserved.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
* or implied. See the License for the specific language governing
* permissions and limitations under the License.
*/
"use strict";window.LH_CURRENT_VERSION="7.0.0";var webtreemap=function(e){const t="webtreemap-node";function n(e){return e.classList.contains(t)}function o(e){let t=0,o=e;for(;o=o.previousElementSibling;)n(o)&&t++;return t}function i(e){let t=[],i=e;for(;i&&n(i);)t.unshift(o(i)),i=i.parentElement;return t.shift(),t}function r(e){return Math.round(e)+"px"}class s{constructor(e,t){this.node=e,this.options=function(e){const t={padding:e.padding||[14,3,3,3],spacing:e.spacing||0,lowerBound:void 0===e.lowerBound?.1:e.lowerBound,applyMutations:e.applyMutations||(()=>null),caption:e.caption||(e=>e.id||""),showNode:e.showNode||((e,n,o)=>n>20&&o>=t.padding[0]),showChildren:e.showChildren||((e,t,n)=>t>40&&n>40)};return t}(t)}ensureDOM(e){if(e.dom)return e.dom;const n=document.createElement("div");if(n.className=t,this.options.caption){const t=document.createElement("div");t.className="webtreemap-caption",t.innerText=this.options.caption(e),n.appendChild(t)}return e.dom=n,this.options.applyMutations(e),n}selectSpan(e,t,n){let o=e[n].size,i=o,r=0,s=0,d=n;for(;d<e.length;d++){const n=e[d].size;n<o&&(o=n),n>i&&(i=n);const l=r+n,c=Math.max(i*t*t/(l*l),l*l/(o*t*t));if(s&&c>s)break;s=c,r=l}return{end:d,sum:r}}layoutChildren(e,t,n,o){const i=e.size,s=e.children;if(!s)return;let d=-1,l=-1,c=n-1,a=o-1;const h=this.options.spacing,p=this.options.padding;l+=p[0],p[1]&&(c-=p[1]+1),a-=p[2],d+=p[3];let f=0;if(this.options.showChildren(e,c-d,a-l)){const n=Math.sqrt(i/((c-d)*(a-l)));var u=d,m=l;e:for(let o=0;o<s.length;){u=d;const l=n*(c-d),{end:a,sum:p}=this.selectSpan(s,l,o);if(p/i<this.options.lowerBound)break;const w=p/l,g=Math.round(w/n)+1;for(f=o;f<a;f++){const o=s[f],i=o.size/w,d=Math.round(i/n)+1;if(!this.options.showNode(o,d-h,g-h))break e;const l=null==o.dom,c=this.ensureDOM(o),a=c.style;a.left=r(u),a.width=r(d-h),a.top=r(m),a.height=r(g-h),l&&e.dom.appendChild(c),this.layoutChildren(o,t+1,d,g),u+=d-1}m+=g-1,o=a}}for(;f<s.length&&s[f].dom;f++)s[f].dom.parentNode.removeChild(s[f].dom),s[f].dom=void 0}render(e){const t=this.ensureDOM(this.node);t.onclick=e=>{let t=e.target;for(;!n(t);)if(t=t.parentElement,!t)return;let o=i(t);this.zoom(o)},e.appendChild(t),this.layout(this.node,e)}layout(e,t){const n=t.offsetWidth,o=t.offsetHeight;e.dom.style.width=n+"px",e.dom.style.height=o+"px",this.layoutChildren(this.node,0,n,o)}zoom(e){let t=this.node;const[n,o,i,s]=this.options.padding;let d=t.dom.offsetWidth,l=t.dom.offsetHeight;for(const c of e){if(d-=s+o,l-=n+i,!t.children)throw new Error("bad address");for(const e of t.children)e.dom&&(e.dom.style.zIndex="0");t=t.children[c];const e=t.dom.style;e.zIndex="1",e.left=r(s-1),e.width=r(d),e.top=r(n-1),e.height=r(l)}this.layoutChildren(t,0,d,l)}}return e.TreeMap=s,e.flatten=function e(t,n=((e,t)=>`${e}/${t}`)){if(t.children){for(const o of t.children)e(o,n);if(1===t.children.length){const e=t.children[0];t.id+="/"+e.id,t.children=e.children}}},e.getAddress=i,e.isDOMNode=n,e.render=function(e,t,n){new s(t,n).render(e)},e.rollup=function e(t){if(!t.children)return;let n=0;for(const o of t.children)e(o),n+=o.size;n>t.size&&(t.size=n)},e.sort=function e(t){if(t.children){for(const n of t.children)e(n);t.children.sort(((e,t)=>t.size-e.size))}},e.treeify=function(e){const t={size:0};for(const[n,o]of e){const e=n.replace(/\/$/,"").split("/");let i=t;for(;e.length>0;){const t=e.shift();i.children||(i.children=[]);let r=i.children.find((e=>e.id===t));if(r||(r={id:t,size:0},i.children.push(r)),0===e.length){if(0!==r.size)throw new Error(`duplicate path ${n} ${r.size}`);r.size=o}i=r}}return t},e}({});function injectOptions(e){if(window.__treemapOptions)return;const t=document.createElement("script");t.textContent=`\n    window.__treemapOptions = ${JSON.stringify(e)};\n  `,document.head.append(t)}function init(e){TreemapUtil.find("main").textContent=JSON.stringify(e.lhr),console.log({webtreemap:webtreemap}),injectOptions(e),console.log("window.__treemapOptions",window.__treemapOptions)}function showError(e){document.body.textContent=e}async function main(){if(window.__treemapOptions)init(window.__treemapOptions);else if(new URLSearchParams(window.location.search).has("debug")){const e=await fetch("debug.json");init(await e.json())}else window.addEventListener("message",(e=>{if(e.source!==self.opener)return;const t=e.data,{lhr:n}=t;if(!n)return showError("Error: Invalid options");if(!n.requestedUrl)return showError("Error: Invalid options");init(t)}));self.opener&&!self.opener.closed&&self.opener.postMessage({opened:!0},"*")}document.addEventListener("DOMContentLoaded",main);class TreemapUtil{static createElement(e,t,n={}){const o=document.createElement(e);return t&&(o.className=t),Object.keys(n).forEach((e=>{const t=n[e];void 0!==t&&o.setAttribute(e,t)})),o}static createChildOf(e,t,n,o){const i=this.createElement(t,n,o);return e.appendChild(i),i}static find(e,t=document){const n=t.querySelector(e);if(null===n)throw new Error(`query ${e} not found`);return n}}"undefined"!=typeof module&&module.exports&&(module.exports=TreemapUtil);